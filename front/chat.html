<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Chat</title>
    <link rel="stylesheet" href="chat.css">
</head>
<body>
    <div class="loading" id="loading">Загрузка...</div>
    
    <div class="container" id="chatApp" style="display: none;">
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="user-info">
                    <div class="user-avatar" id="user-avatar">?</div>
                    <div class="user-name" id="user-name">Пользователь</div>
                </div>
            </div>
            
            <div class="chat-list" id="chatList"></div>
        </div>

        <div class="main-chat">
            <div class="chat-header">
                <div class="header-left">
                    <div class="current-avatar" id="current-avatar">?</div>
                    <div class="header-info">
                        <div class="current-chat-name" id="current-chat-name">Выберите чат</div>
                        <div class="online" id="online-status">---</div>
                    </div>
                </div>
                <div class="header-right">
                    <button id="logoutBtn" title="Выйти">Выйти</button>
                </div>
            </div>

            <div class="messages" id="messages-container">
                <div class="welcome-message">
                    <p>Выберите чат из списка слева, чтобы начать общение</p>
                </div>
            </div>

            <div class="input-area" id="inputArea" style="display: none;">
                <div class="input-wrapper">
                    <input type="text" placeholder="Написать сообщение..." id="message-input">
                    <button id="send-btn">Отправить</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    const API_BASE = "http://localhost:8000";
    const loading = document.getElementById('loading');
    const chatApp = document.getElementById('chatApp');

    let chatsData = {};
    let currentChatId = null;
    let currentUserId = null;
    let currentUserName = null;

    // ======================= СИНХРОННЫЕ ФУНКЦИИ =======================
    function apiRequest(endpoint, options = {}) {
        const url = `${API_BASE}${endpoint}`;
        const token = localStorage.getItem("ACCESS_TOKEN");
        
        console.log(`Запрос к: ${endpoint}`);
        
        const defaultOptions = {
            headers: {
                'Content-Type': 'application/json',
                ...options.headers
            },
            ...options
        };

        // Добавляем токен в заголовок
        if (token) {
            defaultOptions.headers['Authorization'] = `Bearer ${token}`;
            console.log(`Токен добавлен в заголовок`);
        }

        return fetch(url, defaultOptions)
            .then(response => {
                console.log(`Ответ от ${endpoint}: ${response.status}`);
                
                if (response.status === 401) {
                    console.log("Ошибка 401 - токен недействителен");
                    localStorage.clear();
                    alert("Сессия истекла. Пожалуйста, войдите снова.");
                    window.location.href = "login.html";
                    return null;
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                return response.json();
            })
            .catch(error => {
                console.error(`Ошибка запроса ${endpoint}:`, error);
                throw error;
            });
    }

    // ======================= ИНИЦИАЛИЗАЦИЯ =======================
    function init() {
        console.log("Инициализация чата...");
        
        // Проверяем токен
        const token = localStorage.getItem("ACCESS_TOKEN");
        if (!token) {
            alert("Вы не авторизованы. Пожалуйста, войдите.");
            window.location.href = "login.html";
            return;
        }
        
        // Получаем данные пользователя
        apiRequest('/auth/me')
            .then(userData => {
                if (!userData) return;
                
                console.log("Данные пользователя:", userData);
                
                currentUserId = userData.user.id;
                currentUserName = userData.user.short_name || userData.user.first_name || "Пользователь";
                const userAvatar = currentUserName.charAt(0).toUpperCase();
                
                // Обновляем интерфейс
                document.getElementById('user-name').textContent = currentUserName;
                document.getElementById('user-avatar').textContent = userAvatar;
                
                // Загружаем чаты
                return loadChats();
            })
            .then(() => {
                // Показываем интерфейс
                loading.style.display = 'none';
                chatApp.style.display = 'flex';
                
                // Настраиваем обработчики
                setupEventListeners();
                
                console.log("Чат инициализирован");
            })
            .catch(error => {
                console.error("Ошибка инициализации:", error);
                alert("Ошибка авторизации. Пожалуйста, войдите снова.");
                window.location.href = "login.html";
            });
    }

    // ======================= ЗАГРУЗКА ЧАТОВ =======================
    function loadChats() {
        console.log("Загрузка списка чатов...");
        
        return apiRequest('/chat/get_chats')
            .then(chats => {
                console.log("Получены чаты:", chats);
                
                chatsData = {};
                
                if (Array.isArray(chats) && chats.length > 0) {
                    chats.forEach(chat => {
                        const chatId = chat.id;
                        chatsData[chatId] = {
                            id: chatId,
                            name: chat.title || `Чат ${chatId}`,
                            avatar: (chat.title || "Ч").charAt(0).toUpperCase(),
                            messages: [],
                            last_message: chat.last_message || "",
                            last_time: "12:00",
                            serverId: chatId
                        };
                    });
                    
                    renderChatList();
                    
                    // Автоматически выбираем первый чат
                    const firstChatId = Object.keys(chatsData)[0];
                    if (firstChatId) {
                        setTimeout(() => loadChat(firstChatId), 100);
                    }
                } else {
                    showNoChatsMessage();
                }
            })
            .catch(error => {
                console.error("Ошибка загрузки чатов:", error);
                showNoChatsMessage();
            });
    }

    // ======================= ЗАГРУЗКА ЧАТА =======================
    function loadChat(chatId) {
        const chat = chatsData[chatId];
        if (!chat) return;
        
        currentChatId = chatId;
        document.getElementById('current-avatar').textContent = chat.avatar;
        document.getElementById('current-chat-name').textContent = chat.name;
        document.getElementById('inputArea').style.display = 'block';
        document.getElementById('online-status').textContent = 'загружаем...';
        
        console.log(`Загружаем сообщения для чата ID: ${chat.serverId}`);
        
        // Делаем запрос к правильному endpoint
        apiRequest(`/chat/${chat.serverId}/messages?limit=50&offset=0`)
            .then(response => {
                console.log("Ответ от сервера:", response);
                
                // Проверяем структуру ответа
                if (response && response.messages) {
                    console.log(`Сообщение: ${response.messages.length}`);
                    
                    // Преобразуем сообщения согласно структуре ответа
                    chat.messages = response.messages.map(m => {
                        console.log("Сообщение:", m);
                        return {
                            id: m.id || Date.now(),
                            text: m.message || "", // ВАЖНО: поле называется "message", а не "text"
                            time: m.timestamp ? 
                                formatTime(m.timestamp) : 
                                '--:--',
                            fromMe: m.sender && m.sender.id === currentUserId,
                            senderName: m.sender ? (m.sender.short_name || "Пользователь") : "Неизвестно"
                        };
                    });
                    
                    document.getElementById('online-status').textContent = `сообщений: ${chat.messages.length}`;
                } else {
                    console.warn("Нет сообщений или неверный формат ответа:", response);
                    chat.messages = [];
                    document.getElementById('online-status').textContent = 'нет сообщений';
                }
                
                renderMessages(chatId);
                renderChatList();
                
            })
            .catch(error => {
                console.error(`Ошибка загрузки сообщений:`, error);
                
                // Пробуем без offset
                console.log("Пробуем без offset...");
                apiRequest(`/chat/${chat.serverId}/messages?limit=50`)
                    .then(response => {
                        console.log("Ответ без offset:", response);
                        if (response && response.messages) {
                            chat.messages = response.messages.map(m => ({
                                id: m.id || Date.now(),
                                text: m.message || "",
                                time: m.timestamp ? formatTime(m.timestamp) : '--:--',
                                fromMe: m.sender && m.sender.id === currentUserId
                            }));
                            document.getElementById('online-status').textContent = `сообщений: ${chat.messages.length}`;
                        } else {
                            chat.messages = [];
                            document.getElementById('online-status').textContent = 'нет сообщений';
                        }
                        renderMessages(chatId);
                        renderChatList();
                    })
                    .catch(error2 => {
                        console.error("И вторая попытка не удалась:", error2);
                        chat.messages = [];
                        document.getElementById('online-status').textContent = 'ошибка загрузки';
                        renderMessages(chatId);
                        renderChatList();
                    });
            });
    }

    // Добавьте функцию форматирования времени
    function formatTime(timestamp) {
        try {
            const date = new Date(timestamp);
            return date.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
        } catch (e) {
            return '--:--';
        }
    }
    // ======================= ОСТАЛЬНЫЕ ФУНКЦИИ (оставьте как есть) =======================
    function showNoChatsMessage() {
        const chatList = document.getElementById('chatList');
        chatList.innerHTML = `
            <div class="no-chats">
                <p>У вас пока нет чатов</p>
                <p style="font-size: 14px; color: #666; margin-top: 10px;">
                    Начните новый диалог
                </p>
            </div>
        `;
    }

    function renderChatList() {
        const chatList = document.getElementById('chatList');
        
        if (Object.keys(chatsData).length === 0) {
            showNoChatsMessage();
            return;
        }
        
        chatList.innerHTML = '';
        
        Object.values(chatsData).forEach(chat => {
            const div = document.createElement('div');
            div.className = 'chat-item' + (chat.id === currentChatId ? ' active' : '');
            div.dataset.chatId = chat.id;
            div.innerHTML = `
                <div class="avatar">${chat.avatar}</div>
                <div class="chat-info">
                    <div class="chat-header">
                        <span class="chat-name">${chat.name}</span>
                        <span class="time">${chat.last_time}</span>
                    </div>
                    <div class="last-message">
                        <span>${chat.last_message || 'Нет сообщений'}</span>
                    </div>
                </div>
            `;
            
            div.addEventListener('click', () => {
                if (chat.id !== currentChatId) {
                    loadChat(chat.id);
                }
            });
            
            chatList.appendChild(div);
        });
    }

    function renderMessages(chatId) {
        const chat = chatsData[chatId];
        const container = document.getElementById('messages-container');
        
        if (!chat || !chat.messages || chat.messages.length === 0) {
            container.innerHTML = '<div class="no-messages">Нет сообщений</div>';
            return;
        }
        
        container.innerHTML = '';
        
        chat.messages.forEach(msg => {
            const div = document.createElement('div');
            div.className = `message ${msg.fromMe ? 'me' : 'friend'}`;
            
            if (msg.fromMe) {
                div.innerHTML = `
                    <div class="message-content">
                        <div class="message-text">${msg.text || ""}</div>
                        <div class="message-time">${msg.time}</div>
                    </div>
                `;
            } else {
                div.innerHTML = `
                    <div class="message-avatar">${msg.senderName ? msg.senderName.charAt(0).toUpperCase() : "?"}</div>
                    <div class="message-content">
                        <div class="message-sender">${msg.senderName || "Неизвестно"}</div>
                        <div class="message-text">${msg.text || ""}</div>
                        <div class="message-time">${msg.time}</div>
                    </div>
                `;
            }
            
            container.appendChild(div);
        });
        
        setTimeout(() => {
            container.scrollTop = container.scrollHeight;
        }, 100);
    }
    function sendMessage() {
        if (!currentChatId) {
            alert("Выберите чат для отправки сообщения");
            return;
        }
        
        const input = document.getElementById('message-input');
        const text = input.value.trim();
        
        if (!text) return;
        
        const chat = chatsData[currentChatId];
        
        // Локально добавляем сообщение
        const newMsg = {
            id: Date.now(),
            text: text,
            time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}),
            fromMe: true
        };
        
        chat.messages.push(newMsg);
        chat.last_message = text.length > 30 ? text.substring(0, 30) + "..." : text;
        chat.last_time = newMsg.time;
        
        renderMessages(currentChatId);
        renderChatList();
        input.value = '';
        
        // Отправляем на сервер
        apiRequest('/messages/by_user', {
            method: 'POST',
            body: JSON.stringify({ 
                chat_id: chat.serverId,
                text: text
            })
        })
        .then(() => {
            console.log("Сообщение отправлено на сервер");
        })
        .catch(error => {
            console.error("Ошибка отправки на сервер:", error);
        });
    }

    function logout() {
        if (confirm("Вы уверены, что хотите выйти?")) {
            localStorage.clear();
            window.location.href = "login.html";
        }
    }

    function setupEventListeners() {
        document.getElementById('send-btn').addEventListener('click', sendMessage);
        
        document.getElementById('message-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                sendMessage();
            }
        });
        
        document.getElementById('logoutBtn').addEventListener('click', logout);
    }

    // ======================= ЗАПУСК =======================
    document.addEventListener('DOMContentLoaded', init);
    </script>
    
</body>
</html>