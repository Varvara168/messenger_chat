<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Chat</title>
    <link rel="stylesheet" href="chat.css">
</head>
<body>
    <div class="loading" id="loading">Загрузка...</div>
    
    <div class="container" id="chatApp" style="display: none;">
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="user-info">
                    <div class="user-avatar" id="user-avatar">?</div>
                    <div class="user-name" id="user-name">Пользователь</div>
                </div>
            </div>
            
            <div class="chat-list" id="chatList"></div>
        </div>

        <div class="main-chat">
            <div class="chat-header">
                <div class="header-left">
                    <div class="current-avatar" id="current-avatar">?</div>
                    <div class="header-info">
                        <div class="current-chat-name" id="current-chat-name">Выберите чат</div>
                        <div class="online" id="online-status">---</div>
                    </div>
                </div>
                <div class="header-right">
                    <button id="logoutBtn" title="Выйти">Выйти</button>
                </div>
            </div>

            <div class="messages" id="messages-container">
                <div class="welcome-message">
                    <p>Выберите чат из списка слева, чтобы начать общение</p>
                </div>
            </div>

            <div class="input-area" id="inputArea" style="display: none;">
                <div class="input-wrapper">
                    <input type="text" placeholder="Написать сообщение..." id="message-input">
                    <button id="send-btn">Отправить</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    const API_BASE = "http://localhost:8000";
    const loading = document.getElementById('loading');
    const chatApp = document.getElementById('chatApp');

    let chatsData = {};
    let currentChatId = null;
    let currentUserId = null;
    let currentUserName = null;

    // ======================= ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ =======================
    async function apiRequest(endpoint, options = {}) {
        const url = `${API_BASE}${endpoint}`;
        const token = localStorage.getItem("ACCESS_TOKEN");
        
        // ОТЛАДКА
        console.log(`Making request to: ${endpoint}`);
        console.log(`Token from localStorage: ${token ? token.substring(0, 20) + "..." : "NO TOKEN"}`);
        
        const defaultOptions = {
            headers: {
                'Content-Type': 'application/json',
                ...options.headers
            },
            ...options
        };

        // Добавляем токен в заголовок Authorization
        if (token) {
            defaultOptions.headers['Authorization'] = `Bearer ${token}`;
            console.log(`Authorization header set: Bearer ${token.substring(0, 20)}...`);
        } else {
            console.log("No token available for Authorization header");
        }

        try {
            const response = await fetch(url, defaultOptions);
            
            console.log(`Response status for ${endpoint}: ${response.status}`);
            
            if (response.status === 401) {
                console.log("Got 401 - token invalid/expired");
                localStorage.clear();
                alert("Сессия истекла. Пожалуйста, войдите снова.");
                window.location.href = "login.html";
                return null;
            }
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            return await response.json();
        } catch (error) {
            console.error(`Request to ${endpoint} failed:`, error);
            throw error;
        }
    }

    // ======================= ИНИЦИАЛИЗАЦИЯ =======================
    async function init() {
        console.log("Инициализация чата...");
        
        try {
            // Проверяем авторизацию через /me
            const userData = await apiRequest('/auth/me');
            
            if (!userData) {
                // Уже редиректнулись на login
                return;
            }
            
            console.log("Данные пользователя:", userData);
            
            currentUserId = userData.user.id;
            currentUserName = userData.user.short_name || userData.user.first_name || "Пользователь";
            const userAvatar = currentUserName.charAt(0).toUpperCase();
            
            // Обновляем интерфейс
            document.getElementById('user-name').textContent = currentUserName;
            document.getElementById('user-avatar').textContent = userAvatar;
            
            // Загружаем чаты
            await loadChats();
            
            // Показываем интерфейс
            loading.style.display = 'none';
            chatApp.style.display = 'flex';
            
            // Настраиваем обработчики
            setupEventListeners();
            
            console.log("Чат инициализирован");
            
        } catch (error) {
            console.error("Ошибка инициализации:", error);
            alert("Ошибка авторизации. Пожалуйста, войдите снова.");
            window.location.href = "login.html";
        }
    }

    // ======================= ЗАГРУЗКА ЧАТОВ =======================
    async function loadChat(chatId) {
        try {
            const chat = chatsData[chatId];
            if (!chat) return;
            
            currentChatId = chatId;
            
            // Загружаем сообщения
            try {
                // Убедитесь, что передаете правильные параметры
                const messages = await apiRequest(`/chat/${chat.serverId}/messages?limit=50&offset=0`);
                
                if (messages && Array.isArray(messages)) {
                    chat.messages = messages.map(m => ({
                        id: m.id || Date.now(),
                        text: m.text || "",
                        time: m.timestamp ? 
                            new Date(m.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : 
                            '--:--',
                        fromMe: m.user_id === currentUserId
                    }));
                } else {
                    chat.messages = [];
                }
            } catch (error) {
                console.error(`Ошибка загрузки сообщений:`, error);
                chat.messages = [];
            }
            
            renderMessages(chatId);
            
        } catch (error) {
            console.error(`Ошибка загрузки чата:`, error);
        }
    }

    // ======================= РЕНДЕР СПИСКА ЧАТОВ =======================
    function renderChatList() {
        const chatList = document.getElementById('chatList');
        
        if (Object.keys(chatsData).length === 0) {
            showNoChatsMessage();
            return;
        }
        
        chatList.innerHTML = '';
        
        Object.values(chatsData).forEach(chat => {
            const div = document.createElement('div');
            div.className = 'chat-item' + (chat.id === currentChatId ? ' active' : '');
            div.dataset.chatId = chat.id;
            div.innerHTML = `
                <div class="avatar">${chat.avatar}</div>
                <div class="chat-info">
                    <div class="chat-header">
                        <span class="chat-name">${chat.name}</span>
                        <span class="time">${chat.last_time}</span>
                    </div>
                    <div class="last-message">
                        <span>${chat.last_message || 'Нет сообщений'}</span>
                    </div>
                </div>
            `;
            
            div.addEventListener('click', () => {
                if (chat.id !== currentChatId) {
                    loadChat(chat.id);
                }
            });
            
            chatList.appendChild(div);
        });
    }

    function showNoChatsMessage() {
        const chatList = document.getElementById('chatList');
        chatList.innerHTML = `
            <div class="no-chats">
                <p>У вас пока нет чатов</p>
                <p style="font-size: 14px; color: #666; margin-top: 10px;">
                    Начните новый диалог
                </p>
            </div>
        `;
    }

    // ======================= ЗАГРУЗКА ЧАТА =======================
    async function loadChat(chatId) {
        try {
            const chat = chatsData[chatId];
            if (!chat) return;
            
            currentChatId = chatId;
            document.getElementById('current-avatar').textContent = chat.avatar;
            document.getElementById('current-chat-name').textContent = chat.name;
            document.getElementById('inputArea').style.display = 'block';
            document.getElementById('online-status').textContent = 'загружаем...';
            
            // Загружаем сообщения
            try {
                const messages = await apiRequest(`/chat/${chat.serverId}/messages?limit=50&offset=0`);
                
                if (messages && Array.isArray(messages)) {
                    chat.messages = messages.map(m => ({
                        id: m.id || Date.now(),
                        text: m.text || "",
                        time: m.timestamp ? 
                            new Date(m.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : 
                            '--:--',
                        fromMe: m.user_id === currentUserId
                    }));
                    
                    document.getElementById('online-status').textContent = `сообщений: ${chat.messages.length}`;
                } else {
                    chat.messages = [];
                    document.getElementById('online-status').textContent = 'нет сообщений';
                }
            } catch (error) {
                console.error(`Ошибка загрузки сообщений:`, error);
                chat.messages = [];
                document.getElementById('online-status').textContent = 'ошибка';
            }
            
            renderMessages(chatId);
            renderChatList();
            
        } catch (error) {
            console.error(`Ошибка загрузки чата:`, error);
            alert(`Ошибка загрузки чата: ${error.message}`);
        }
    }

    // ======================= РЕНДЕР СООБЩЕНИЙ =======================
    function renderMessages(chatId) {
        const chat = chatsData[chatId];
        const container = document.getElementById('messages-container');
        
        if (!chat || !chat.messages || chat.messages.length === 0) {
            container.innerHTML = '<div class="no-messages">Нет сообщений</div>';
            return;
        }
        
        container.innerHTML = '';
        
        chat.messages.forEach(msg => {
            const div = document.createElement('div');
            div.className = `message ${msg.fromMe ? 'me' : 'friend'}`;
            
            if (msg.fromMe) {
                div.innerHTML = `
                    <div class="message-content">
                        <div class="message-text">${msg.text}</div>
                        <div class="message-time">${msg.time}</div>
                    </div>
                `;
            } else {
                div.innerHTML = `
                    <div class="message-avatar">${chat.avatar}</div>
                    <div class="message-content">
                        <div class="message-text">${msg.text}</div>
                        <div class="message-time">${msg.time}</div>
                    </div>
                `;
            }
            
            container.appendChild(div);
        });
        
        setTimeout(() => {
            container.scrollTop = container.scrollHeight;
        }, 100);
    }

    // ======================= ОТПРАВКА СООБЩЕНИЯ =======================
    async function sendMessage() {
        if (!currentChatId) {
            alert("Выберите чат для отправки сообщения");
            return;
        }
        
        const input = document.getElementById('message-input');
        const text = input.value.trim();
        
        if (!text) return;
        
        try {
            const chat = chatsData[currentChatId];
            
            // Локально добавляем сообщение
            const newMsg = {
                id: Date.now(),
                text: text,
                time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}),
                fromMe: true
            };
            
            chat.messages.push(newMsg);
            chat.last_message = text.length > 30 ? text.substring(0, 30) + "..." : text;
            chat.last_time = newMsg.time;
            
            renderMessages(currentChatId);
            renderChatList();
            input.value = '';
            
            // Отправляем на сервер
            try {
                await apiRequest('/messages/by_user', {
                    method: 'POST',
                    body: JSON.stringify({ 
                        chat_id: chat.serverId,
                        text: text
                    })
                });
                console.log("Сообщение отправлено на сервер");
            } catch (error) {
                console.error("Ошибка отправки на сервер:", error);
            }
            
        } catch (error) {
            console.error("Ошибка отправки сообщения:", error);
            alert("Ошибка отправки: " + error.message);
        }
    }

    // ======================= ВЫХОД =======================
    async function logout() {
        if (confirm("Вы уверены, что хотите выйти?")) {
            try {
                await apiRequest('/auth/logout', {
                    method: 'POST'
                });
            } catch (error) {
                console.error("Ошибка при выходе:", error);
            }
            
            localStorage.clear();
            window.location.href = "login.html";
        }
    }

    // ======================= НАСТРОЙКА ОБРАБОТЧИКОВ =======================
    function setupEventListeners() {
        document.getElementById('send-btn').addEventListener('click', sendMessage);
        
        document.getElementById('message-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                sendMessage();
            }
        });
        
        document.getElementById('logoutBtn').addEventListener('click', logout);
    }

    // ======================= ЗАПУСК =======================
    document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>