<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ß–∞—Ç</title>
    <link rel="stylesheet" href="chat.css">
</head>
<body>
    <div class="loading" id="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    
    <div class="container" id="chatApp" style="display: none;">
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="user-info">
                    <div class="user-avatar" id="user-avatar">?</div>
                    <div class="user-name" id="user-name">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</div>
                </div>
            </div>
            <div class="search-box" id="chatSearchBox">
                <div class="search-icon">üîç</div>
                <input 
                    type="text" 
                    placeholder="–ü–æ–∏—Å–∫" 
                    id="universalSearchInput"
                    autocomplete="off"
                >
                <div class="clear-search" id="clearUniversalSearch" style="display: none;">‚úï</div>
            </div>
            <div class="chat-list" id="chatList"></div>
        </div>
        
        <div class="main-chat">
            <div class="chat-header">
                <div class="header-left">
                    <div class="current-avatar" id="current-avatar">?</div>
                    <div class="header-info">
                        <div class="current-chat-name" id="current-chat-name">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</div>
                        <div class="online" id="online-status">---</div>
                    </div>
                </div>
                <div class="header-right">
                    <button id="logoutBtn" title="–í—ã–π—Ç–∏">–í—ã–π—Ç–∏</button>
                </div>
            </div>

            <div class="messages" id="messages-container">
                <div class="welcome-message">
                    <p>–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –∏–∑ —Å–ø–∏—Å–∫–∞ —Å–ª–µ–≤–∞, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ</p>
                </div>
            </div>

            <div class="input-area" id="inputArea" style="display: none;">
                <div class="input-wrapper">
                    <input type="text" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ..." id="message-input">
                    <button id="send-btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    const API_BASE = "http://localhost:8000";
    const loading = document.getElementById('loading');
    const chatApp = document.getElementById('chatApp');

    let chatsData = {};
    let currentChatId = null;
    let currentUserId = null;
    let currentUserName = null;

    // ======================= –ì–ï–ù–ï–†–ê–¶–ò–Ø –¶–í–ï–¢–ê –ü–û –ò–ú–ï–ù–ò =======================
    function getAvatarColor(name) {
        if (!name) return '#0088cc';
        
        let hash = 0;
        for (let i = 0; i < name.length; i++) {
            hash = name.charCodeAt(i) + ((hash << 5) - hash);
        }
        
        const colors = [
            '#0088cc', '#27ae60', '#e74c3c', '#9b59b6', '#f39c12',
            '#1abc9c', '#d35400', '#3498db', '#2ecc71', '#e67e22',
            '#16a085', '#8e44ad', '#2c3e50', '#f1c40f', '#7f8c8d'
        ];
        
        const index = Math.abs(hash) % colors.length;
        return colors[index];
    }

    // ======================= –°–ò–ù–•–†–û–ù–ù–´–ï –§–£–ù–ö–¶–ò–ò =======================
    function apiRequest(endpoint, options = {}) { // –°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∫ API
        const url = `${API_BASE}${endpoint}`; 
        const token = localStorage.getItem("ACCESS_TOKEN");
        
        console.log(`–ó–∞–ø—Ä–æ—Å –∫: ${endpoint}`);
        
        const defaultOptions = {
            headers: {
                'Content-Type': 'application/json',
                ...options.headers
            },
            ...options
        };

        // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–∫–µ–Ω –≤ –∑–∞–≥–æ–ª–æ–≤–æ–∫
        if (token) {
            defaultOptions.headers['Authorization'] = `Bearer ${token}`;
            console.log(`–¢–æ–∫–µ–Ω –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∑–∞–≥–æ–ª–æ–≤–æ–∫`);
        }

        return fetch(url, defaultOptions)
            .then(response => {
                console.log(`–û—Ç–≤–µ—Ç –æ—Ç ${endpoint}: ${response.status}`);
                
                if (response.status === 401) {
                    console.log("–û—à–∏–±–∫–∞ 401 - —Ç–æ–∫–µ–Ω –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω");
                    localStorage.clear();
                    alert("–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.");
                    window.location.href = "login.html";
                    return null;
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                return response.json();
            })
            .catch(error => {
                console.error(`–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ ${endpoint}:`, error);
                throw error;
            });
    }

    // ======================= –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø =======================
    function init() {
        console.log("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —á–∞—Ç–∞...");
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–∫–µ–Ω
        const token = localStorage.getItem("ACCESS_TOKEN");
        if (!token) {
            alert("–í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ.");
            window.location.href = "login.html";
            return;
        }
        
        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        apiRequest('/auth/me')
            .then(userData => {
                if (!userData) return;
                
                console.log("–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", userData);
                
                currentUserId = userData.user.id;
                currentUserName = userData.user.first_name || userData.user.first_name || "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å";
                const userAvatar = currentUserName.charAt(0).toUpperCase();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                document.getElementById('user-name').textContent = currentUserName;
                document.getElementById('user-avatar').textContent = userAvatar;
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —á–∞—Ç—ã
                return loadChats();
            })
            .then(() => {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                loading.style.display = 'none';
                chatApp.style.display = 'flex';
                
                // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
                setupEventListeners();
                
                console.log("–ß–∞—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω");
            })
            .catch(error => {
                console.error("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:", error);
                alert("–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.");
                window.location.href = "login.html";
            });
    }

    // ======================= –ó–ê–ì–†–£–ó–ö–ê –ß–ê–¢–û–í =======================
    function loadChats() {
        console.log("–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤...");
        
        return apiRequest('/chat/get_chats')
            .then(chats => {
                console.log("–ü–æ–ª—É—á–µ–Ω—ã —á–∞—Ç—ã:", chats);
                
                chatsData = {};
                
                if (Array.isArray(chats) && chats.length > 0) {
                    chats.forEach(chat => {
                        const chatId = chat.id;
                        const chatName = chat.title || `–ß–∞—Ç ${chatId}`;
                        
                        // –°–û–•–†–ê–ù–Ø–ï–ú –¶–í–ï–¢ –î–õ–Ø –≠–¢–û–ì–û –ß–ê–¢–ê
                        const avatarColor = getAvatarColor(chatName);
                        
                        chatsData[chatId] = {
                            id: chatId,
                            name: chatName,
                            avatar: (chat.title || "–ß").charAt(0).toUpperCase(),
                            messages: [],
                            last_message: chat.last_message || "",
                            last_time: "12:00",
                            serverId: chatId,
                            avatarColor: avatarColor  // –¶–í–ï–¢
                        };
                    });
                    
                    renderChatList();
                    
                    // –ü–†–û–í–ï–†–Ø–ï–ú, –ï–°–¢–¨ –õ–ò –°–û–•–†–ê–ù–ï–ù–ù–´–ô –ß–ê–¢
                    const savedChatId = localStorage.getItem('LAST_OPENED_CHAT');
                    let chatToOpen = null;
                    
                    if (savedChatId && chatsData[savedChatId]) {
                        // –ï—Å–ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —á–∞—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ —Å–ø–∏—Å–∫–µ - –æ—Ç–∫—Ä—ã–≤–∞–µ–º –µ–≥–æ
                        chatToOpen = savedChatId;
                        console.log("–í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —á–∞—Ç:", savedChatId);
                    } else {
                        // –ò–Ω–∞—á–µ –±–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π —á–∞—Ç
                        chatToOpen = Object.keys(chatsData)[0];
                    }
                    
                    if (chatToOpen) {
                        setTimeout(() => loadChat(chatToOpen), 100);
                    }
                } else {
                    showNoChatsMessage();
                }
            })
            .catch(error => {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–æ–≤:", error);
                showNoChatsMessage();
            });
    }

    // ======================= –ó–ê–ì–†–£–ó–ö–ê –ß–ê–¢–ê =======================
    function loadChat(chatId) {
        const chat = chatsData[chatId];
        if (!chat) return;
        
        currentChatId = chatId;
        localStorage.setItem('LAST_OPENED_CHAT', chatId);
        
        // –£–°–¢–ê–ù–ê–í–õ–ò–í–ê–ï–ú –û–î–ò–ù –ò –¢–û–¢ –ñ–ï –¶–í–ï–¢ –í –ó–ê–ì–û–õ–û–í–ö–ï
        document.getElementById('current-avatar').textContent = chat.avatar;
        document.getElementById('current-avatar').style.backgroundColor = chat.avatarColor || '#0088cc';
        
        document.getElementById('current-chat-name').textContent = chat.name;
        document.getElementById('inputArea').style.display = 'block';
        document.getElementById('online-status').textContent = '–∑–∞–≥—Ä—É–∂–∞–µ–º...';
        
        console.log(`–ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è —á–∞—Ç–∞ ID: ${chat.serverId}`);
        
        apiRequest(`/chat/${chat.serverId}/messages?limit=50&offset=0`)
            .then(response => {
                console.log("–û—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:", response);
                
                if (response && response.messages) {
                    console.log(`–°–æ–æ–±—â–µ–Ω–∏–π: ${response.messages.length}`);
                    
                    chat.messages = response.messages.map(m => {
                        const senderName = m.sender ? 
                            (m.sender.first_name || m.sender.short_name || "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å") : 
                            "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ";
                        
                        // –î–õ–Ø –°–û–û–ë–©–ï–ù–ò–ô –î–†–£–ì–ò–• –õ–Æ–î–ï–ô - –ò–°–ü–û–õ–¨–ó–£–ï–ú –¶–í–ï–¢ –ß–ê–¢–ê
                        // (–µ—Å–ª–∏ —ç—Ç–æ –≥—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç, –ª—É—á—à–µ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ü–≤–µ—Ç –ø–æ –∏–º–µ–Ω–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è)
                        const avatarColor = chat.avatarColor || getAvatarColor(senderName);
                        
                        return {
                            id: m.id || Date.now(),
                            text: m.message || "",
                            time: m.timestamp ? formatTime(m.timestamp) : '--:--',
                            fromMe: m.sender && m.sender.id === currentUserId,
                            senderName: senderName,
                            avatarColor: avatarColor,
                            timestamp: m.timestamp,  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª–Ω—É—é –¥–∞—Ç—É –æ—Ç–ø—Ä–∞–≤–∫–∏
                            readAt: m.read_at,      // –ö–æ–≥–¥–∞ –ø—Ä–æ—á–∏—Ç–∞–Ω–æ (null –µ—Å–ª–∏ –Ω–µ –ø—Ä–æ—á–∏—Ç–∞–Ω–æ)
                            deliveredAt: m.delivered_at  // –ö–æ–≥–¥–∞ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ
                        };
                    });
                    
                    document.getElementById('online-status').textContent = `—Å–æ–æ–±—â–µ–Ω–∏–π: ${chat.messages.length}`;
                } else {
                    console.warn("–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –∏–ª–∏ –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:", response);
                    chat.messages = [];
                    document.getElementById('online-status').textContent = '–Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π';
                }
                
                renderMessages(chatId);
                renderChatList();
            })
            .catch(error => {
                console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:`, error);

                console.log("–ü—Ä–æ–±—É–µ–º –±–µ–∑ offset...");
                apiRequest(`/chat/${chat.serverId}/messages?limit=50`)
                    .then(response => {
                        console.log("–û—Ç–≤–µ—Ç –±–µ–∑ offset:", response);
                        if (response && response.messages) {
                            chat.messages = response.messages.map(m => ({
                                id: m.id || Date.now(),
                                text: m.message || "",
                                time: m.timestamp ? formatTime(m.timestamp) : '--:--',
                                fromMe: m.sender && m.sender.id === currentUserId
                            }));
                            document.getElementById('online-status').textContent = `—Å–æ–æ–±—â–µ–Ω–∏–π: ${chat.messages.length}`;
                        } else {
                            chat.messages = [];
                            document.getElementById('online-status').textContent = '–Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π';
                        }
                        renderMessages(chatId);
                        renderChatList();
                    })
                    .catch(error2 => {
                        console.error("–ò –≤—Ç–æ—Ä–∞—è –ø–æ–ø—ã—Ç–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å:", error2);
                        chat.messages = [];
                        document.getElementById('online-status').textContent = '–æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
                        renderMessages(chatId);
                        renderChatList();
                    });
            });
    }

    // –î–æ–±–∞–≤—å—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏
    function formatTime(timestamp) {
        try {
            const date = new Date(timestamp);
            return date.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
        } catch (e) {
            return '--:--';
        }
    }

    // ======================= –ü–û–ò–°–ö –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô =======================

    let searchTimer = null; // –¢–∞–π–º–µ—Ä –¥–ª—è –∑–∞–¥–µ—Ä–∂–∫–∏ –ø–æ–∏—Å–∫–∞

    // –ò—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∫–æ–≥–¥–∞ –ø–µ—á–∞—Ç–∞—é—Ç –≤ –ø–æ–∏—Å–∫–µ
    function searchUsers(query) {
        const chatList = document.getElementById('chatList');
        
        // –ï—Å–ª–∏ –ø–æ–∏—Å–∫ –ø—É—Å—Ç–æ–π - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—ã—á–Ω—ã–µ —á–∞—Ç—ã
        if (!query.trim()) {
            renderChatList();
            return;
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á—Ç–æ –∏—â–µ–º
        chatList.innerHTML = '<div class="search-loading">–ò—â–µ–º...</div>';
        
        // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —É –±—ç–∫–µ–Ω–¥–∞
        apiRequest(`/search/users?query=${encodeURIComponent(query)}`)
            .then(users => {
                // –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞—à–ª–∏
                if (!users || users.length === 0) {
                    chatList.innerHTML = '<div class="search-no-results">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞—à–ª–∏</div>';
                    return;
                }
                
                // –£–±–∏—Ä–∞–µ–º —Å–µ–±—è –∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
                const otherUsers = users.filter(user => user.id !== currentUserId);
                
                if (otherUsers.length === 0) {
                    chatList.innerHTML = '<div class="search-no-results">–¢–æ–ª—å–∫–æ –≤—ã –ø–æ–¥–æ—à–ª–∏</div>';
                    return;
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö
                showFoundUsers(otherUsers);
            })
            .catch(error => {
                console.error("–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞:", error);
                chatList.innerHTML = '<div class="search-no-results">–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞</div>';
            });
    }

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    function showFoundUsers(users) {
        const chatList = document.getElementById('chatList');
        chatList.innerHTML = '';
        
        users.forEach(user => {
            // –ë–µ—Ä–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const userName = user.first_name || user.short_name || "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å";
            const userPhone = user.phone || "–¢–µ–ª–µ—Ñ–æ–Ω –Ω–µ —É–∫–∞–∑–∞–Ω";
            const userAvatar = userName.charAt(0).toUpperCase();
            const avatarColor = getAvatarColor(userName);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ —á–∞—Ç —Å —ç—Ç–∏–º —á–µ–ª–æ–≤–µ–∫–æ–º
            let existingChat = null;
            for (const chatId in chatsData) {
                const chat = chatsData[chatId];
                // –ï—Å–ª–∏ –∏–º—è —á–∞—Ç–∞ –ø–æ—Ö–æ–∂–µ –Ω–∞ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                if (chat.name === userName || chat.name.includes(user.short_name)) {
                    existingChat = chat;
                    break;
                }
            }
            
            // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const userElement = document.createElement('div');
            userElement.className = 'user-search-result';
            
            // –ï—Å–ª–∏ —á–∞—Ç —É–∂–µ –µ—Å—Ç—å - —Å—Ç—Ä–µ–ª–∫–∞, –µ—Å–ª–∏ –Ω–µ—Ç - –ø–ª—é—Å–∏–∫
            const buttonSymbol = existingChat ? '‚Üí' : '+';
            const buttonClass = existingChat ? 'added' : '';
            const buttonTitle = existingChat ? '–û—Ç–∫—Ä—ã—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —á–∞—Ç' : '–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —á–∞—Ç';
            
            userElement.innerHTML = `
                <div class="user-search-avatar" style="background-color: ${avatarColor}">
                    ${userAvatar}
                </div>
                <div class="user-search-info">
                    <div class="user-search-name" title="${userName}">${userName}</div>
                    <div class="user-search-phone" title="${userPhone}">${userPhone}</div>
                </div>
                <button class="user-search-add-btn ${buttonClass}" 
                        data-user-id="${user.id}"
                        data-user-name="${userName}"
                        data-has-chat="${!!existingChat}"
                        title="${buttonTitle}">
                    ${buttonSymbol}
                </button>
            `;
            
            chatList.appendChild(userElement);
        });
    }

    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ (+ –∏–ª–∏ ‚Üí)
    function handleUserButtonClick(userId, userName, hasChat) {
        if (hasChat) {
            // –ï—Å–ª–∏ —á–∞—Ç —É–∂–µ –µ—Å—Ç—å - –∏—â–µ–º –∏ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –µ–≥–æ
            for (const chatId in chatsData) {
                const chat = chatsData[chatId];
                if (chat.name === userName) {
                    loadChat(chat.id);
                    // –û—á–∏—â–∞–µ–º –ø–æ–∏—Å–∫
                    clearSearch();
                    return;
                }
            }
        } else {
            // –ï—Å–ª–∏ —á–∞—Ç–∞ –Ω–µ—Ç - —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π
            createNewChatWithUser(userId, userName);
        }
    }

    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —á–∞—Ç —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
    function createNewChatWithUser(userId, userName) {
        const chatList = document.getElementById('chatList');
        chatList.innerHTML = '<div class="search-loading">–°–æ–∑–¥–∞–µ–º —á–∞—Ç...</div>';
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ —á–∞—Ç–∞
        apiRequest('/chat/create_chat', {
            method: 'POST',
            body: JSON.stringify({
                creds: userId
            })
        })
        .then(newChat => {
            console.log("–°–æ–∑–¥–∞–Ω —á–∞—Ç:", newChat);
            
            // –î–æ–±–∞–≤–ª—è–µ–º —á–∞—Ç –≤ –Ω–∞—à —Å–ø–∏—Å–æ–∫
            const chatId = newChat.id;
            const chatName = newChat.title || userName;
            const avatarColor = getAvatarColor(chatName);
            
            chatsData[chatId] = {
                id: chatId,
                name: chatName,
                avatar: chatName.charAt(0).toUpperCase(),
                messages: [],
                last_message: "",
                last_time: "—Ç–æ–ª—å–∫–æ —á—Ç–æ",
                serverId: chatId,
                avatarColor: avatarColor
            };
            
            // –û—á–∏—â–∞–µ–º –ø–æ–∏—Å–∫
            clearSearch();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—ã—á–Ω—ã–µ —á–∞—Ç—ã
            renderChatList();
            
            // –ß–µ—Ä–µ–∑ –ø–æ–ª—Å–µ–∫—É–Ω–¥—ã –æ—Ç–∫—Ä—ã–≤–∞–µ–º —Å–æ–∑–¥–∞–Ω–Ω—ã–π —á–∞—Ç
            setTimeout(() => {
                loadChat(chatId);
            }, 500);
            
        })
        .catch(error => {
            console.error("–ù–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —á–∞—Ç:", error);
            alert(`–û—à–∏–±–∫–∞: ${error.message || "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —á–∞—Ç"}`);
            renderChatList();
        });
    }

    // –û—á–∏—â–∞–µ–º –ø–æ–∏—Å–∫
    function clearSearch() {
        document.getElementById('universalSearchInput').value = '';
        document.getElementById('clearUniversalSearch').style.display = 'none';
    }

       
    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ø–æ–∏—Å–∫–∞
    function setupSearchListeners() {
        const searchInput = document.getElementById('universalSearchInput');
        const clearBtn = document.getElementById('clearUniversalSearch');
        
        // –ö–æ–≥–¥–∞ –ø–µ—á–∞—Ç–∞—é—Ç –≤ –ø–æ–∏—Å–∫–µ
        searchInput.addEventListener('input', (e) => {
            const hasText = e.target.value.length > 0;
            clearBtn.style.display = hasText ? 'block' : 'none';
            
            // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–π —Ç–∞–π–º–µ—Ä
            clearTimeout(searchTimer);
            
            // –ñ–¥–µ–º 400–º—Å –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–π –±—É–∫–≤—ã
            searchTimer = setTimeout(() => {
                searchUsers(e.target.value);
            }, 400);
        });
        
        // –ö–Ω–æ–ø–∫–∞ –æ—á–∏—Å—Ç–∫–∏
        clearBtn.addEventListener('click', () => {
            searchInput.value = '';
            clearBtn.style.display = 'none';
            renderChatList(); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—ã—á–Ω—ã–µ —á–∞—Ç—ã
        });
        
        // –ö–æ–≥–¥–∞ –Ω–∞–∂–∏–º–∞—é—Ç –Ω–∞ –∫–Ω–æ–ø–∫—É —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        document.getElementById('chatList').addEventListener('click', (e) => {
            if (e.target.classList.contains('user-search-add-btn')) {
                const userId = e.target.dataset.userId;
                const userName = e.target.dataset.userName;
                const hasChat = e.target.dataset.hasChat === 'true';
                
                handleUserButtonClick(userId, userName, hasChat);
            }
        });
    }

    // ======================= –û–°–¢–ê–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò (–æ—Å—Ç–∞–≤—å—Ç–µ –∫–∞–∫ –µ—Å—Ç—å) =======================
    function showNoChatsMessage() {
        const chatList = document.getElementById('chatList');
        chatList.innerHTML = `
            <div class="no-chats">
                <p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —á–∞—Ç–æ–≤</p>
                <p style="font-size: 14px; color: #666; margin-top: 10px;">
                    –ù–∞—á–Ω–∏—Ç–µ –Ω–æ–≤—ã–π –¥–∏–∞–ª–æ–≥
                </p>
            </div>
        `;
    }

    function renderChatList() {
        const chatList = document.getElementById('chatList');
        const searchInput = document.getElementById('universalSearchInput');
        
        // –ï—Å–ª–∏ –µ—Å—Ç—å —Ç–µ–∫—Å—Ç –≤ –ø–æ–∏—Å–∫–µ - –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—ã—á–Ω—ã–µ —á–∞—Ç—ã
        if (searchInput && searchInput.value.trim()) {
            return;
        }
        
        if (Object.keys(chatsData).length === 0) {
            showNoChatsMessage();
            return;
        }
        
        chatList.innerHTML = '';
        
        Object.values(chatsData).forEach(chat => {
            const div = document.createElement('div');
            div.className = 'chat-item' + (chat.id === currentChatId ? ' active' : '');
            div.dataset.chatId = chat.id;
            div.innerHTML = `
                <div class="avatar" style="background-color: ${chat.avatarColor || '#0088cc'}">
                    ${chat.avatar}
                </div>
                <div class="chat-info">
                    <div class="chat-header">
                        <span class="chat-name">${chat.name}</span>
                        <span class="time">${chat.last_time}</span>
                    </div>
                    <div class="last-message">
                        <span>${chat.last_message || '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π'}</span>
                    </div>
                </div>
            `;
            
            div.addEventListener('click', () => {
                if (chat.id !== currentChatId) {
                    loadChat(chat.id);
                }
            });
            
            chatList.appendChild(div);
        });
    }
 
    function renderMessages(chatId) {
        const chat = chatsData[chatId];
        const container = document.getElementById('messages-container');
        
        if (!chat || !chat.messages || chat.messages.length === 0) {
            container.innerHTML = '<div class="no-messages">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</div>';
            return;
        }
        
        container.innerHTML = '';
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —ç—Ç–æ –ª–∏—á–Ω—ã–π —á–∞—Ç –∏–ª–∏ –≥—Ä—É–ø–ø–æ–≤–æ–π
        const isPersonalChat = chat.name && !chat.name.includes('–ß–∞—Ç'); // –∏–ª–∏ –¥—Ä—É–≥–∞—è –ª–æ–≥–∏–∫–∞
        
        chat.messages.forEach(msg => {
            const div = document.createElement('div');
            div.className = `message ${msg.fromMe ? 'me' : 'friend'}`;
            div.dataset.messageId = msg.id;
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–æ–æ–±—â–µ–Ω–∏—è (—Ç–æ–ª—å–∫–æ –¥–ª—è –º–æ–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π)
            let statusIcon = '‚àí';  // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –º–∏–Ω—É—Å (–Ω–µ –ø—Ä–æ—á–∏—Ç–∞–Ω–æ)
            let statusTitle = '–ù–µ –ø—Ä–æ—á–∏—Ç–∞–Ω–æ';
            
            if (msg.fromMe) {
                if (msg.readAt) {
                    statusIcon = '+';  // –ü–ª—é—Å –µ—Å–ª–∏ –ø—Ä–æ—á–∏—Ç–∞–Ω–æ
                    statusTitle = `–ü—Ä–æ—á–∏—Ç–∞–Ω–æ: ${formatDateTime(msg.readAt)}`;
                }
                // –ï—Å–ª–∏ deliveredAt –Ω–µ –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –µ–≥–æ
            }
            
            if (msg.fromMe) {
                // –¢–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
                div.innerHTML = `
                    <div class="message-content">
                        <div class="message-text">${msg.text || ""}</div>
                        <div class="message-time">
                            <span class="message-status" title="${statusTitle}">${statusIcon}</span>
                            ${msg.time}
                        </div>
                    </div>
                `;
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ —Å—Ç–∞—Ç—É—Å
                const statusElement = div.querySelector('.message-status');
                if (statusElement) {
                    statusElement.addEventListener('click', (e) => {
                        e.stopPropagation();
                        showMessageDetails(msg);
                    });
                }
            } else {
                // –°–æ–æ–±—â–µ–Ω–∏—è –¥—Ä—É–≥–∏—Ö
                if (isPersonalChat) {
                    // –õ–∏—á–Ω—ã–π —á–∞—Ç - –±–µ–∑ –∏–º–µ–Ω–∏ –∏ –∞–≤–∞—Ç–∞—Ä–∞
                    div.innerHTML = `
                        <div class="message-content">
                            <div class="message-text">${msg.text || ""}</div>
                            <div class="message-time">${msg.time}</div>
                        </div>
                    `;
                } else {
                    // –ì—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç - —Å –∏–º–µ–Ω–µ–º –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
                    div.innerHTML = `
                        <div class="message-content">
                            <div class="message-sender">${msg.senderName || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"}</div>
                            <div class="message-text">${msg.text || ""}</div>
                            <div class="message-time">${msg.time}</div>
                        </div>
                    `;
                }
            }
            
            container.appendChild(div);
        });
        
        setTimeout(() => {
            container.scrollTop = container.scrollHeight;
        }, 100);
    }

    // –§—É–Ω–∫—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞—Ç—ã-–≤—Ä–µ–º–µ–Ω–∏
    function formatTime(timestamp) {
        try {
            // –ï—Å–ª–∏ –≤—Ä–µ–º—è –ø—Ä–∏—à–ª–æ –±–µ–∑ 'Z' (–Ω–µ UTC), –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ
            let timeStr = timestamp;
            if (timeStr && !timeStr.endsWith('Z') && timeStr.includes('T')) {
                timeStr += 'Z'; // –£–∫–∞–∑—ã–≤–∞–µ–º —á—Ç–æ —ç—Ç–æ UTC
            }
            
            const date = new Date(timeStr);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –¥–∞—Ç—ã
            if (isNaN(date.getTime())) {
                throw new Error('Invalid date');
            }
            
            return date.toLocaleTimeString([], {
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            });
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –≤—Ä–µ–º–µ–Ω–∏:', timestamp, e);
            return '--:--';
        }
    }

    function formatDateTime(dateString) {
        if (!dateString) return '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
        
        try {
            const date = new Date(dateString);
            // –ü–æ–ª–Ω–∞—è –¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –≤ —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            return date.toLocaleString('ru-RU', {
                day: '2-digit',
                month: '2-digit', 
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
        } catch (e) {
            return '–æ—à–∏–±–∫–∞ –¥–∞—Ç—ã';
        }
    }

    // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑
    function scrollToBottom() {
        const container = document.getElementById('messages-container');
        if (container) {
            setTimeout(() => {
                container.scrollTop = container.scrollHeight;
            }, 50);
        }
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–Ω–∏–∑—É –ª–∏ –º—ã
    function isAtBottom() {
        const container = document.getElementById('messages-container');
        if (!container) return true;
        
        // –ù–∞ 100 –ø–∏–∫—Å–µ–ª–µ–π –æ—Ç –Ω–∏–∑–∞ —Å—á–∏—Ç–∞–µ–º —á—Ç–æ "–≤–Ω–∏–∑—É"
        const threshold = 100;
        const distance = container.scrollHeight - container.scrollTop - container.clientHeight;
        return distance <= threshold;
    }
    
    // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –¥–µ—Ç–∞–ª–µ–π —Å–æ–æ–±—â–µ–Ω–∏—è
    function showMessageDetails(message) {
        let details = '';
        
        if (message.timestamp) {
            details += `<p><strong>–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ:</strong> ${formatDateTime(message.timestamp)}</p>`;
        }
        
        if (message.readAt) {
            details += `<p><strong>–ü—Ä–æ—á–∏—Ç–∞–Ω–æ:</strong> ${formatDateTime(message.readAt)}</p>`;
        } else {
            details += `<p><strong>–ü—Ä–æ—á–∏—Ç–∞–Ω–æ:</strong> –µ—â–µ –Ω–µ –ø—Ä–æ—á–∏—Ç–∞–Ω–æ</p>`;
        }
        
        // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        const modal = document.createElement('div');
        modal.className = 'message-details-modal';
        modal.innerHTML = `
            <div class="modal-content">
                <div class="modal-header">
                    <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–æ–æ–±—â–µ–Ω–∏–∏</h3>
                    <button class="close-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="message-preview">
                        <p><strong>–¢–µ–∫—Å—Ç:</strong> ${message.text || "(–±–µ–∑ —Ç–µ–∫—Å—Ç–∞)"}</p>
                    </div>
                    <div class="message-details">
                        ${details}
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –Ω–∞ –∫—Ä–µ—Å—Ç–∏–∫ –∏–ª–∏ –≤–Ω–µ –æ–∫–Ω–∞
        modal.querySelector('.close-modal').addEventListener('click', () => {
            modal.remove();
        });
        
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.remove();
            }
        });
    }

    function sendMessage() {
        if (!currentChatId) {
            alert("–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è");
            return;
        }
        
        const input = document.getElementById('message-input');
        const text = input.value.trim();
        
        if (!text) return;
        
        const chat = chatsData[currentChatId];
        
        // –õ–æ–∫–∞–ª—å–Ω–æ –¥–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        const newMsg = {
            id: Date.now(),
            text: text,
            time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}),
            fromMe: true
        };
        
        chat.messages.push(newMsg);
        chat.last_message = text.length > 30 ? text.substring(0, 30) + "..." : text;
        chat.last_time = newMsg.time;
        
        renderMessages(currentChatId);
        renderChatList();
        input.value = '';
        
        // –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        apiRequest('/messages/by_user', {
            method: 'POST',
            body: JSON.stringify({ 
                id_query: String(chat.serverId),  // –ë—ç–∫–µ–Ω–¥ –æ–∂–∏–¥–∞–µ—Ç "id_query" –∫–∞–∫ —Å—Ç—Ä–æ–∫—É
                content: text                     // –ë—ç–∫–µ–Ω–¥ –æ–∂–∏–¥–∞–µ—Ç "content"
            })
        })
        .then(response => {
            if (response) {
                console.log("–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä:", response);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º ID —Å–æ–æ–±—â–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–∞ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
                if (response.id) {
                    newMsg.id = response.id;
                }
            }
        })
        .catch(error => {
            console.error("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä:", error);
            alert("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å.");
        });
    }

    function logout() {
        if (confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?")) {
            localStorage.clear();
            window.location.href = "login.html";
        }
    }


    function setupEventListeners() {
        setupSearchListeners();
        document.getElementById('send-btn').addEventListener('click', sendMessage);
        
        document.getElementById('message-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                sendMessage();
            }
        });
        
    
        
        document.getElementById('logoutBtn').addEventListener('click', logout);
    }

    // ======================= –ó–ê–ü–£–°–ö =======================
    document.addEventListener('DOMContentLoaded', init);
    </script>
    
</body>
</html>