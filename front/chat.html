<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ß–∞—Ç</title>
    <!-- <link rel="stylesheet" href="/static/chat.css"> -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
        }

        .container {
            width: 100%;
            height: 100vh;
            display: flex;
        }

        /* –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å */
        .sidebar {
            width: 20%;
            min-width: 320px;
            max-width: 400px;
            background: #f8f8f8;
            border-right: 1px solid #e0e0e0;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .chat-list {
            padding: 10px;
        }

        .chat-item {
            display: flex;
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }

        .chat-item:hover {
            background: #f0f0f0;
        }

        .chat-item.active {
            background: #ebf5ff;
        }

        .avatar {
            width: 50px;
            height: 50px;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
            margin-right: 10px;
        }

        .chat-info {
            flex: 1;
            min-width: 0;
        }

        .chat-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .chat-name {
            font-weight: bold;
            font-size: 16px;
            color: #000;
        }

        .time {
            font-size: 12px;
            color: #999;
        }

        .last-message {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .last-message span:first-child {
            font-size: 14px;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
        }

        .unread {
            background: #0088cc;
            color: white;
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
        }

        /* –û—Å–Ω–æ–≤–Ω–æ–π —á–∞—Ç */
        .main-chat {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #e5ddd5;
            min-height: 0; /* –í–∞–∂–Ω–æ –¥–ª—è flex-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
        }

        .chat-header {
            background: #0088cc;
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            align-items: center;
        }

        .current-avatar {
            width: 40px;
            height: 40px;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            border: 2px solid white;
            margin-right: 10px;
        }

        .header-info {
            display: flex;
            flex-direction: column;
        }

        .current-chat-name {
            font-weight: bold;
            font-size: 16px;
        }

        .online {
            font-size: 12px;
            opacity: 0.9;
        }

        .header-right button {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 5px 10px;
        }

        /* –°–æ–æ–±—â–µ–Ω–∏—è */

        .message {
            display: flex;
            max-width: 70%;
        }

        .message.friend {
            align-self: flex-start;
        }

        .message.me {
            align-self: flex-end;
        }

        .message-avatar {
            width: 35px;
            height: 35px;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 8px;
            align-self: flex-end;
            flex-shrink: 0;
        }

        .message-content {
            background: white;
            padding: 10px 15px;
            border-radius: 10px;
            position: relative;
            max-width: 100%;
        }

        .message.me .message-content {
            background: #dcf8c6;
        }

        .message-text {
            font-size: 14px;
            line-height: 1.4;
            color: #333;
            margin-bottom: 5px;
        }

        .message-time {
            font-size: 11px;
            color: #999;
            text-align: right;
        }

        /* –ü–æ–ª–µ –≤–≤–æ–¥–∞ */
        .input-area {
            background: #f0f0f0;
            padding: 15px;
            border-top: 1px solid #ddd;
        }

        .input-wrapper {
            display: flex;
            gap: 10px;
        }

        .input-wrapper input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-size: 14px;
            outline: none;
        }

        .input-wrapper input:focus {
            border-color: #0088cc;
        }

        .input-wrapper button {
            background: #0088cc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
        }

        .input-wrapper button:hover {
            background: #0077b3;
        }

        .messages {
            flex: 1; /* –ó–∞–Ω–∏–º–∞–µ—Ç –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ */
            min-height: 0; 
            overflow-y: auto; /* –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ */
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }


        .messages::-webkit-scrollbar {
            width: 6px;
        }

        .messages::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .messages::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        .messages::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }


        /* –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 18px;
            color: #666;
            z-index: 1000;
        }

        .no-chats {
            padding: 20px;
            text-align: center;
            color: #666;
        }

        .sidebar-header {
            padding: 15px;
            background: #0088cc;
            color: white;
            border-bottom: 1px solid #0077b3;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background-color: #255500;
            color: #f0f0f0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
        }

        .user-name {
            font-weight: bold;
            font-size: 16px;
        }

        .welcome-message {
            text-align: center;
            color: #666;
            padding: 40px 20px;
            font-size: 16px;
        }

        .no-messages {
            text-align: center;
            color: #666;
            padding: 40px 20px;
            font-size: 16px;
        }
                
        #logoutBtn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 5px 15px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 14px;
        }

        #deleteChatBtn {
            background: rgba(190, 0, 0, 0.582);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 5px 15px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 14px;

        }

        .message-status {
            display: inline-block;
            margin-right: 4px;
            cursor: pointer;
            font-weight: bold;
            color: #999;
            transition: color 0.2s;
            user-select: none;
            font-size: 14px;
        }

        .message-status:hover {
            color: #0088cc;
        }

        .message-details-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            padding: 20px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 16px;
            color: #333;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
            line-height: 1;
        }

        .close-modal:hover {
            color: #333;
        }

        .modal-body {
            font-size: 14px;
        }

        .message-preview {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            border-left: 3px solid #0088cc;
        }

        .message-details p {
            margin: 8px 0;
            line-height: 1.4;
        }

        .message-details strong {
            color: #555;
            min-width: 80px;
            display: inline-block;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–æ–∏—Å–∫–∞ */
        .search-box {
            padding: 12px 15px;
            position: relative;
            border-bottom: 1px solid #e1e1e1;
            background: white;
            z-index: 2;
        }

        .search-box input {
            width: 100%;
            padding: 8px 12px 8px 35px;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
            box-sizing: border-box;
        }

        .search-box input:focus {
            border-color: #0088cc;
        }

        .search-box .search-icon {
            position: absolute;
            left: 25px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
            font-size: 14px;
            pointer-events: none;
        }

        .search-box .clear-search {
            position: absolute;
            right: 25px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
            cursor: pointer;
            font-size: 16px;
            padding: 4px;
        }

        .search-box .clear-search:hover {
            color: #333;
        }

        /* –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π */
        .user-search-result {
            padding: 12px 15px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid #f5f5f5
        }

        .user-search-result:hover {
            background: #f9f9f9;
        }

        .user-search-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .user-search-info {
            flex: 1;
            min-width: 0; /* –î–ª—è –æ–±—Ä–µ–∑–∞–Ω–∏—è –¥–ª–∏–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ */
        }

        .user-search-name {
            font-weight: 500;
            color: #333;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-search-phone {
            font-size: 12px;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-search-add-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid #0088cc;
            background: white;
            color: #0088cc;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
            margin-left: 10px;
        }

        .user-search-add-btn:hover {
            background: #0088cc;
            color: white;
        }

        .user-search-add-btn.added {
            border-color: #27ae60;
            color: #27ae60;
        }

        .user-search-add-btn.added:hover {
            background: #27ae60;
            color: white;
        }

        /* –°–æ–æ–±—â–µ–Ω–∏—è –ø—Ä–∏ –ø–æ–∏—Å–∫–µ */
        .search-info {
            padding: 20px 15px;
            text-align: center;
            color: #666;
            font-size: 14px;
        }

        .search-loading {
            padding: 15px;
            text-align: center;
            color: #999;
        }

        .search-no-results {
            padding: 20px 15px;
            text-align: center;
            color: #999;
            font-style: italic;
        }

        /* –¶–≤–µ—Ç–∞ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å—Ç–∞—Ç—É—Å–æ–≤ */
        .status-online {
            color: #27ae60 !important;
        }

        .status-offline {
            color: #95a5a6 !important;
        }

        .status-last-seen {
            color: #7f8c8d !important;
        }

        /* –ê–Ω–∏–º–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ */
        .status-loading {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #0088cc;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .date-divider {
            text-align: center;
            margin: 20px 0;
            position: relative;
        }

        .date-divider span {
            background-color: #e5ddd5;
            color: #666;
            font-size: 12px;
            padding: 4px 12px;
            border-radius: 12px;
            display: inline-block;
        }

        /* –õ–∏–Ω–∏—è –ø–µ—Ä–µ–¥ –∏ –ø–æ—Å–ª–µ –¥–∞—Ç—ã */
        .date-divider::before,
        .date-divider::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 40%;
            height: 1px;
            background-color: #ddd;
        }

        .date-divider::before {
            left: 0;
        }

        .date-divider::after {
            right: 0;
        }

        /* –î–ª—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —á–∞—Ç–∞ */
        .main-chat {
            background: #e5ddd5;
            position: relative;
        }

        /* –£–ª—É—á—à–∞–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–µ–π –≤ —Ç–µ–º–Ω–æ–º —á–∞—Ç–µ */
        .messages {
            background: #e5ddd5;
            padding: 10px;
        }

        .date-divider {
            margin: 15px 0;
        }

        .date-divider span {
            background-color: rgba(255, 255, 255, 0.7);
            color: #555;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="loading" id="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    
    <div class="container" id="chatApp" style="display: none;">
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="user-info">
                    <div class="user-avatar" id="user-avatar">?</div>
                    <div class="user-name" id="user-name">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</div>
                    <button id="logoutBtn" title="–í—ã–π—Ç–∏">–í—ã–π—Ç–∏</button>
                </div>
            </div>
            <div class="search-box" id="chatSearchBox">
                <div class="search-icon">üîç</div>
                <input 
                    type="text" 
                    placeholder="–ü–æ–∏—Å–∫" 
                    id="universalSearchInput"
                    autocomplete="off"
                >
                <div class="clear-search" id="clearUniversalSearch" style="display: none;">‚úï</div>
            </div>
            <div class="chat-list" id="chatList"></div>
        </div>
        
        <div class="main-chat">
            <div class="chat-header">
                <div class="header-left">
                    <div class="current-avatar" id="current-avatar">?</div>
                    <div class="header-info">
                        <div class="current-chat-name" id="current-chat-name">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</div>
                        <div class="online" id="online-status">---</div>
                    </div>
                </div>
                <div class="header-right">
                    <button id="deleteChatBtn" title="–£–¥–∞–ª–∏—Ç—å">–£–¥–∞–ª–∏—Ç—å</button>
                </div>
            </div>

            <div class="messages" id="messages-container">
                <div class="welcome-message">
                    <p>–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –∏–∑ —Å–ø–∏—Å–∫–∞ —Å–ª–µ–≤–∞, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ</p>
                </div>
            </div>

            <div class="input-area" id="inputArea" style="display: none;">
                <div class="input-wrapper">
                    <input type="text" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ..." id="message-input">
                    <button id="send-btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    const API_BASE = "";
    const loading = document.getElementById('loading');
    const chatApp = document.getElementById('chatApp');

    let chatsData = {};
    let currentChatId = null;
    let currentUserId = null;
    let currentUserName = null;
    
    // –î–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤
    let currentPartnerId = null;
    let statusCheckInterval = null;

    // ======================= –ì–ï–ù–ï–†–ê–¶–ò–Ø –¶–í–ï–¢–ê –ü–û –ò–ú–ï–ù–ò =======================
    function getAvatarColor(name) {
        if (!name) return '#0088cc';
        
        let hash = 0;
        for (let i = 0; i < name.length; i++) {
            hash = name.charCodeAt(i) + ((hash << 5) - hash);
        }
        
        const colors = [
            '#0088cc', '#27ae60', '#e74c3c', '#9b59b6', '#f39c12',
            '#1abc9c', '#d35400', '#3498db', '#2ecc71', '#e67e22',
            '#16a085', '#8e44ad', '#2c3e50', '#f1c40f', '#7f8c8d'
        ];
        
        const index = Math.abs(hash) % colors.length;
        return colors[index];
    }

    // ======================= API –ó–ê–ü–†–û–°–´ =======================
    function apiRequest(endpoint, options = {}) {
        const url = `${API_BASE}${endpoint}`; 
        const token = localStorage.getItem("ACCESS_TOKEN");
        
        const defaultOptions = {
            headers: {
                'Content-Type': 'application/json',
                ...options.headers
            },
            ...options
        };

        if (token) {
            defaultOptions.headers['Authorization'] = `Bearer ${token}`;
        }

        return fetch(url, defaultOptions)
            .then(response => {
                if (response.status === 401) {
                    localStorage.clear();
                    alert("–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.");
                    window.location.href = "/";
                    return null;
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                return response.json();
            })
            .catch(error => {
                console.error(`–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ ${endpoint}:`, error);
                throw error;
            });
    }

    // ======================= –°–¢–ê–¢–£–°–´ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô =======================
    
    async function getUserStatus(userId) {
        try {
            const response = await apiRequest(`/user/${userId}/status`);
            return response;
        } catch (error) {
            console.error(`–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userId}:`, error);
            return null;
        }
    }
    
    async function updateMyStatus(isOnline) {
        try {
            const response = await apiRequest(`/user/status/update?is_online=${isOnline}`, {
                method: 'POST'
            });
            console.log('–°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω:', response.message);
            return response;
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞:', error);
        }
    }
    
    async function getChatPartnerId(chatId) {
        try {
            const response = await apiRequest(`/chat/${chatId}/partner_id`);
            return response.partner_id;
        } catch (error) {
            console.error(`–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è partner_id:`, error);
            return null;
        }
    }
    
    function formatExactTime(timestamp) {
        if (!timestamp) return '–Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –±—ã–ª(–∞) –≤ —Å–µ—Ç–∏';
        
        // –ï—Å–ª–∏ timestamp —É–∂–µ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω —Å–µ—Ä–≤–µ—Ä–æ–º
        if (typeof timestamp === 'string') {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ —É–∂–µ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è
            if (timestamp.includes('.') || timestamp.includes(':') || timestamp.includes('-')) {
                // –ü—Ä–æ–±—É–µ–º —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å
                try {
                    const date = new Date(timestamp);
                    if (!isNaN(date.getTime())) {
                        // –£—Å–ø–µ—à–Ω–æ —Ä–∞—Å–ø–∞—Ä—Å–∏–ª–∏ - —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º
                        return formatSimpleDate(date);
                    }
                } catch (e) {
                    // –ù–µ —Å–º–æ–≥–ª–∏ —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å
                    return timestamp;
                }
            }
        }
        
        // –ü—Ä–æ–±—É–µ–º —Å–æ–∑–¥–∞—Ç—å –¥–∞—Ç—É
        try {
            const date = new Date(timestamp);
            if (isNaN(date.getTime())) {
                return '–≤—Ä–µ–º—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
            }
            return formatSimpleDate(date);
        } catch (e) {
            return '–≤—Ä–µ–º—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
        }
    }

    function formatSimpleDate(date) {
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate() - 1);
        
        const timeStr = date.toLocaleTimeString('ru-RU', {
            hour: '2-digit',
            minute: '2-digit',
            hour12: false
        });
        
        if (date >= today) {
            return `—Å–µ–≥–æ–¥–Ω—è –≤ ${timeStr}`;
        }
        
        if (date >= yesterday) {
            return `–≤—á–µ—Ä–∞ –≤ ${timeStr}`;
        }
        
        const dateStr = date.toLocaleDateString('ru-RU', {
            day: '2-digit',
            month: '2-digit',
            year: date.getFullYear() !== now.getFullYear() ? 'numeric' : undefined
        });
        
        return `${dateStr} –≤ ${timeStr}`;
    }
        
    async function updatePartnerStatus() {
        if (!currentChatId || !currentPartnerId) return;
        
         const status = await getUserStatus(currentPartnerId);
        const statusElement = document.getElementById('online-status');
        
        if (!status) {
            statusElement.textContent = '—Å—Ç–∞—Ç—É—Å –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω';
            statusElement.style.color = '#7f8c8d';
            return;
        }
        
        if (status.is_online) {
            statusElement.textContent = '–æ–Ω–ª–∞–π–Ω';
            statusElement.style.color = '#27ae60';
            statusElement.title = '–°–µ–π—á–∞—Å –æ–Ω–ª–∞–π–Ω';
        } else {
            const exactTime = formatExactTime(status.last_seen);
            statusElement.textContent = `–±—ã–ª(–∞) ${exactTime}`;
            statusElement.style.color = '#7f8c8d';
            statusElement.title = `–ë—ã–ª(–∞) –≤ —Å–µ—Ç–∏: ${exactTime}`;
        }
    }
    
    function markMeOnline() {
        if (!currentUserId) return;
        
        updateMyStatus(true);
        
        window.addEventListener('beforeunload', () => {
            updateMyStatus(false);
        });
    }

    // ======================= –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø =======================
    function init() {
        console.log("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —á–∞—Ç–∞...");
        
        const token = localStorage.getItem("ACCESS_TOKEN");
        if (!token) {
            alert("–í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ.");
            window.location.href = "/";
            return;
        }
        
        apiRequest('/auth/me')
            .then(userData => {
                if (!userData) return;
                
                currentUserId = userData.user.id;
                currentUserName = userData.user.first_name || "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å";
                const userAvatar = currentUserName.charAt(0).toUpperCase();
                
                document.getElementById('user-name').textContent = currentUserName;
                document.getElementById('user-avatar').textContent = userAvatar;
                document.getElementById('user-avatar').style.backgroundColor = getAvatarColor(currentUserName);
                
                document.getElementById('deleteChatBtn').disabled = true;

                markMeOnline();
                
                return loadChats();
            })
            .then(() => {
                loading.style.display = 'none';
                chatApp.style.display = 'flex';
                
                setupEventListeners();
                
                console.log("–ß–∞—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω");
            })
            .catch(error => {
                console.error("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:", error);
                alert("–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.");
                window.location.href = "/";
            });
    }


    // ======================= –ó–ê–ì–†–£–ó–ö–ê –ß–ê–¢–û–í –° –°–û–û–ë–©–ï–ù–ò–Ø–ú–ò =======================
    function loadChats() {
        console.log("–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤...");
        
        return apiRequest('/chat/get_chats')
        .then(chats => {
            chatsData = {};
            if (!Array.isArray(chats) || chats.length === 0) {
                showNoChatsMessage();
                return;
            }

            const loadPromises = chats.map(chat => {
                const chatId = chat.id;
                const chatName = chat.title || `–ß–∞—Ç ${chatId}`;
                const avatarColor = getAvatarColor(chatName);

                chatsData[chatId] = {
                    id: chatId,
                    name: chatName,
                    avatar: (chat.title || "–ß").charAt(0).toUpperCase(),
                    messages: [],
                    last_message: "",
                    last_time: '–∑–∞–≥—Ä—É–∑–∫–∞...',
                    last_message_raw: null,
                    serverId: chatId,
                    avatarColor: avatarColor
                };

                // –í–°–ï–ì–î–ê –ø–æ–¥–≥—Ä—É–∂–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                return apiRequest(`/chat/${chatId}/messages?limit=1`)
                    .then(res => {
                        if (res?.messages?.length) {
                            const lastMsg = res.messages[res.messages.length - 1];
                            chatsData[chatId].last_message = lastMsg.message || '';
                            chatsData[chatId].last_message_raw = lastMsg.timestamp;
                            chatsData[chatId].last_time = formatChatTime(lastMsg.timestamp);
                        } else {
                            chatsData[chatId].last_time = '–Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π';
                            chatsData[chatId].last_message_raw = null;
                        }
                    })
                    .catch(() => {
                        chatsData[chatId].last_time = '–æ—à–∏–±–∫–∞';
                        chatsData[chatId].last_message_raw = null;
                    });
            });

            return Promise.all(loadPromises)
                .then(() => {
                    // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ –≤—Å–µ –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—É—á–µ–Ω—ã
                    const sortedChatIds = Object.keys(chatsData).sort((a, b) => {
                        const timeA = chatsData[a].last_message_raw ? new Date(chatsData[a].last_message_raw).getTime() : 0;
                        const timeB = chatsData[b].last_message_raw ? new Date(chatsData[b].last_message_raw).getTime() : 0;
                        return timeB - timeA;
                    });

                    const sortedChatsData = {};
                    sortedChatIds.forEach(id => sortedChatsData[id] = chatsData[id]);
                    chatsData = sortedChatsData;

                    renderChatList();

                    const savedChatId = localStorage.getItem('LAST_OPENED_CHAT') || Object.keys(chatsData)[0];
                    if (savedChatId) setTimeout(() => loadChat(savedChatId), 100);
                });
        })
        .catch(err => {
            console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–æ–≤:", err);
            showNoChatsMessage();
        });
    }

    // ======================= –ó–ê–ì–†–£–ó–ö–ê –ß–ê–¢–ê =======================
    function loadChat(chatId) {
        const chat = chatsData[chatId];
        if (!chat) return;
        
        console.log("=== –ó–ê–ì–†–£–ó–ö–ê –ß–ê–¢–ê ===");
        console.log("–ß–∞—Ç:", chat.name);
        console.log("–¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –≤ last_time:", chat.last_time);
        console.log("–¢–µ–∫—É—â–µ–µ raw –≤—Ä–µ–º—è:", chat.last_message_raw);
        
        currentChatId = chatId;
        localStorage.setItem('LAST_OPENED_CHAT', chatId);
        
        currentPartnerId = null;
        
        if (statusCheckInterval) {
            clearInterval(statusCheckInterval);
        }
        
        document.getElementById('current-avatar').textContent = chat.avatar;
        document.getElementById('current-avatar').style.backgroundColor = chat.avatarColor || '#0088cc';
        document.getElementById('current-chat-name').textContent = chat.name;
        document.getElementById('inputArea').style.display = 'block';
        document.getElementById('online-status').textContent = '–∑–∞–≥—Ä—É–∂–∞–µ–º...';
        document.getElementById('online-status').style.color = '#7f8c8d';
        
        const deleteBtn = document.getElementById('deleteChatBtn')
        deleteBtn.disabled = false;
        deleteBtn.title = `–£–¥–∞–ª–∏—Ç—å —á–∞—Ç "${chat.name}" –¥–ª—è –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤`;

        getChatPartnerId(chat.serverId)
            .then(partnerId => {
                if (partnerId) {
                    currentPartnerId = partnerId;
                    updatePartnerStatus();
                    statusCheckInterval = setInterval(updatePartnerStatus, 10000);
                } else {
                    document.getElementById('online-status').textContent = 
                        `—Å–æ–æ–±—â–µ–Ω–∏–π: ${chat.messages.length}`;
                }
            })
            .catch(error => {
                console.error("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è partnerId:", error);
                document.getElementById('online-status').textContent = 
                    `—Å–æ–æ–±—â–µ–Ω–∏–π: ${chat.messages.length}`;
            });
        
        console.log(`–ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è —á–∞—Ç–∞ ID: ${chat.serverId}`);
        
        apiRequest(`/chat/${chat.serverId}/messages?limit=50`)
            .then(response => {
                if (response && response.messages) {
                    chat.messages = response.messages.map(m => {
                        const senderName = m.sender ? 
                            (m.sender.first_name || m.sender.short_name || "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å") : 
                            "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ";
                        
                        const avatarColor = chat.avatarColor || getAvatarColor(senderName);
                        
                        return {
                            id: m.id || Date.now(),
                            text: m.message || "",
                            time: m.timestamp ? formatTime(m.timestamp) : '--:--',
                            fromMe: m.sender && m.sender.id === currentUserId,
                            senderName: senderName,
                            avatarColor: avatarColor,
                            timestamp: m.timestamp,
                            readAt: m.read_at,
                            deliveredAt: m.delivered_at
                        };
                    });
                    
                    if (chat.messages.length > 0) {
                        const lastMsg = chat.messages[chat.messages.length - 1];
                        chat.last_message = lastMsg.text.length > 30 ? 
                            lastMsg.text.substring(0, 30) + "..." : lastMsg.text;
                        
                        if (lastMsg.timestamp) {
                            chat.last_time = formatChatTime(lastMsg.timestamp);
                            chat.last_message_raw = lastMsg.timestamp;
                        }
                    }
                    
                    if (!currentPartnerId) {
                        document.getElementById('online-status').textContent = 
                            `—Å–æ–æ–±—â–µ–Ω–∏–π: ${chat.messages.length}`;
                    }
                } else {
                    chat.messages = [];
                    if (!currentPartnerId) {
                        document.getElementById('online-status').textContent = '–Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π';
                    }
                }
                
                renderMessages(chatId);
                renderChatList();
            })
            .catch(error => {
                console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:`, error);
                chat.messages = [];
                if (!currentPartnerId) {
                    document.getElementById('online-status').textContent = '–æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
                }
                renderMessages(chatId);
                renderChatList();
            });

    }

    // ======================= –ü–û–ò–°–ö –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô =======================
    let searchTimer = null;

    function searchUsers(query) {
        const chatList = document.getElementById('chatList');
        
        if (!query.trim()) {
            renderChatList();
            return;
        }
        
        chatList.innerHTML = '<div class="search-loading">–ò—â–µ–º...</div>';
        
        apiRequest(`/search/users?query=${encodeURIComponent(query)}`)
            .then(users => {
                if (!users || users.length === 0) {
                    chatList.innerHTML = '<div class="search-no-results">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞—à–ª–∏</div>';
                    return;
                }
                
                const otherUsers = users.filter(user => user.id !== currentUserId);
                
                if (otherUsers.length === 0) {
                    chatList.innerHTML = '<div class="search-no-results">–¢–æ–ª—å–∫–æ –≤—ã –ø–æ–¥–æ—à–ª–∏</div>';
                    return;
                }
                
                showFoundUsers(otherUsers);
            })
            .catch(error => {
                console.error("–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞:", error);
                chatList.innerHTML = '<div class="search-no-results">–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞</div>';
            });
    }

    function showFoundUsers(users) {
        const chatList = document.getElementById('chatList');
        chatList.innerHTML = '';
        
        users.forEach(user => {
            const userName = user.first_name || user.short_name || "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å";
            const userPhone = user.phone || "–¢–µ–ª–µ—Ñ–æ–Ω –Ω–µ —É–∫–∞–∑–∞–Ω";
            const userAvatar = userName.charAt(0).toUpperCase();
            const avatarColor = getAvatarColor(userName);
            
            let existingChat = null;
            for (const chatId in chatsData) {
                const chat = chatsData[chatId];
                if (chat.name === userName || chat.name.includes(user.short_name)) {
                    existingChat = chat;
                    break;
                }
            }
            
            const userElement = document.createElement('div');
            userElement.className = 'user-search-result';
            
            const buttonSymbol = existingChat ? '‚Üí' : '+';
            const buttonClass = existingChat ? 'added' : '';
            const buttonTitle = existingChat ? '–û—Ç–∫—Ä—ã—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —á–∞—Ç' : '–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —á–∞—Ç';
            
            userElement.innerHTML = `
                <div class="user-search-avatar" style="background-color: ${avatarColor}">
                    ${userAvatar}
                </div>
                <div class="user-search-info">
                    <div class="user-search-name" title="${userName}">${userName}</div>
                    <div class="user-search-phone" title="${userPhone}">${userPhone}</div>
                </div>
                <button class="user-search-add-btn ${buttonClass}" 
                        data-user-id="${user.id}"
                        data-user-name="${userName}"
                        data-has-chat="${!!existingChat}"
                        title="${buttonTitle}">
                    ${buttonSymbol}
                </button>
            `;
            
            chatList.appendChild(userElement);
        });
    }

    function handleUserButtonClick(userId, userName, hasChat) {
        if (hasChat) {
            for (const chatId in chatsData) {
                const chat = chatsData[chatId];
                if (chat.name === userName) {
                    loadChat(chat.id);
                    clearSearch();
                    return;
                }
            }
        } else {
            createNewChatWithUser(userId, userName);
        }
    }

    function createNewChatWithUser(userId, userName) {
        const chatList = document.getElementById('chatList');
        chatList.innerHTML = '<div class="search-loading">–°–æ–∑–¥–∞–µ–º —á–∞—Ç...</div>';
        
        apiRequest('/chat/create_chat', {
            method: 'POST',
            body: JSON.stringify({
                creds: userId
            })
        })
        .then(newChat => {
            console.log("–°–æ–∑–¥–∞–Ω —á–∞—Ç:", newChat);
            
            const chatId = newChat.id;
            const chatName = newChat.title || userName;
            const avatarColor = getAvatarColor(chatName);
            
            chatsData[chatId] = {
                id: chatId,
                name: chatName,
                avatar: chatName.charAt(0).toUpperCase(),
                messages: [],
                last_message: "",
                last_time: "—Ç–æ–ª—å–∫–æ —á—Ç–æ",
                serverId: chatId,
                avatarColor: avatarColor
            };
            
            clearSearch();
            renderChatList();
            
            setTimeout(() => {
                loadChat(chatId);
            }, 500);
            
        })
        .catch(error => {
            console.error("–ù–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —á–∞—Ç:", error);
            alert(`–û—à–∏–±–∫–∞: ${error.message || "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —á–∞—Ç"}`);
            renderChatList();
        });
    }

    function clearSearch() {
        document.getElementById('universalSearchInput').value = '';
        document.getElementById('clearUniversalSearch').style.display = 'none';
    }
    
    function setupSearchListeners() {
        const searchInput = document.getElementById('universalSearchInput');
        const clearBtn = document.getElementById('clearUniversalSearch');
        
        searchInput.addEventListener('input', (e) => {
            const hasText = e.target.value.length > 0;
            clearBtn.style.display = hasText ? 'block' : 'none';
            
            clearTimeout(searchTimer);
            
            searchTimer = setTimeout(() => {
                searchUsers(e.target.value);
            }, 400);
        });
        
        clearBtn.addEventListener('click', () => {
            searchInput.value = '';
            clearBtn.style.display = 'none';
            renderChatList();
        });
        
        document.getElementById('chatList').addEventListener('click', (e) => {
            if (e.target.classList.contains('user-search-add-btn')) {
                const userId = e.target.dataset.userId;
                const userName = e.target.dataset.userName;
                const hasChat = e.target.dataset.hasChat === 'true';
                
                handleUserButtonClick(userId, userName, hasChat);
            }
        });
    }

    function showNoChatsMessage() {
        const chatList = document.getElementById('chatList');
        chatList.innerHTML = `
            <div class="no-chats">
                <p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —á–∞—Ç–æ–≤</p>
                <p style="font-size: 14px; color: #666; margin-top: 10px;">
                    –ù–∞—á–Ω–∏—Ç–µ –Ω–æ–≤—ã–π –¥–∏–∞–ª–æ–≥
                </p>
            </div>
        `;

        document.getElementById('deleteChatBtn').disabled = true;
    }
    
    function renderChatList() {
        const chatList = document.getElementById('chatList');
        const searchInput = document.getElementById('universalSearchInput');
        
        // –ï—Å–ª–∏ –∏–¥–µ—Ç –ø–æ–∏—Å–∫ - –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—ã—á–Ω—ã–µ —á–∞—Ç—ã
        if (searchInput && searchInput.value.trim()) {
            return;
        }
        
        // –ï—Å–ª–∏ –Ω–µ—Ç —á–∞—Ç–æ–≤
        if (Object.keys(chatsData).length === 0) {
            showNoChatsMessage();
            return;
        }
        
        chatList.innerHTML = '';
        
        // –í–ê–ñ–ù–û: –°–û–†–¢–ò–†–û–í–ö–ê - –ù–û–í–´–ï –ß–ê–¢–´ –í–í–ï–†–•–£
        const sortedChats = Object.values(chatsData).sort((a, b) => {
            // –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç–µ A
            const timeA = a.last_message_raw ? new Date(a.last_message_raw).getTime() : 0;
            // –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç–µ B
            const timeB = b.last_message_raw ? new Date(b.last_message_raw).getTime() : 0;
            
            // –ï—Å–ª–∏ –æ–±–∞ –±–µ–∑ —Å–æ–æ–±—â–µ–Ω–∏–π - –Ω–æ–≤—ã–µ —á–∞—Ç—ã –≤–≤–µ—Ä—Ö—É
            if (!timeA && !timeB) {
                return b.id - a.id; // –ß–∞—Ç —Å –±–æ–ª—å—à–∏–º ID (–Ω–æ–≤—ã–π) –≤–≤–µ—Ä—Ö—É
            }
            
            // –ï—Å–ª–∏ –æ–¥–∏–Ω –±–µ–∑ —Å–æ–æ–±—â–µ–Ω–∏–π - –æ–Ω –≤–Ω–∏–∑—É
            if (!timeA) return 1;
            if (!timeB) return -1;
            
            // –°–û–†–¢–ò–†–û–í–ö–ê: –ë–û–õ–¨–®–ï–ï –≤—Ä–µ–º—è (–ù–û–í–û–ï) -> –í–í–ï–†–•–£
            // –ú–ï–ù–¨–®–ï–ï –≤—Ä–µ–º—è (–°–¢–ê–†–û–ï) -> –í–ù–ò–ó–£
            return timeB - timeA;
        });
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —á–∞—Ç—ã
        sortedChats.forEach(chat => {
            const div = document.createElement('div');
            div.className = 'chat-item' + (chat.id === currentChatId ? ' active' : '');
            div.dataset.chatId = chat.id;
            
            // –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
            let timeDisplay = '–Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π';
            if (chat.last_message_raw) {
                timeDisplay = formatChatTime(chat.last_message_raw);
            }
            
            div.innerHTML = `
                <div class="avatar" style="background-color: ${chat.avatarColor || '#0088cc'}">
                    ${chat.avatar}
                </div>
                <div class="chat-info">
                    <div class="chat-header">
                        <span class="chat-name">${chat.name}</span>
                        <span class="time">
                            ${timeDisplay}
                        </span>
                    </div>
                    <div class="last-message">
                        <span>${chat.last_message || '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π'}</span>
                    </div>
                </div>
            `;
            
            // –ü—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —á–∞—Ç - –æ—Ç–∫—Ä—ã–≤–∞–µ–º –µ–≥–æ
            div.addEventListener('click', () => {
                if (chat.id !== currentChatId) {
                    loadChat(chat.id);
                }
            });
            
            chatList.appendChild(div);
        });
    }
    
    function renderMessages(chatId) {
        const chat = chatsData[chatId];
        const container = document.getElementById('messages-container');
        
        if (!chat || !chat.messages || chat.messages.length === 0) {
            container.innerHTML = '<div class="no-messages">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</div>';
            return;
        }
        
        container.innerHTML = '';
        
        const isPersonalChat = chat.name && !chat.name.includes('–ß–∞—Ç');
        let currentDate = null;
        
        chat.messages.forEach(msg => {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–∞—Ç—É —Å–æ–æ–±—â–µ–Ω–∏—è
            if (msg.timestamp) {
                const messageDate = new Date(msg.timestamp);
                const dateString = formatMessageDate(messageDate);
                
                // –ï—Å–ª–∏ –¥–∞—Ç–∞ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å - –¥–æ–±–∞–≤–ª—è–µ–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å
                if (dateString !== currentDate) {
                    currentDate = dateString;
                    
                    const dateDivider = document.createElement('div');
                    dateDivider.className = 'date-divider';
                    dateDivider.innerHTML = `<span>${dateString}</span>`;
                    container.appendChild(dateDivider);
                }
            }
            
            const div = document.createElement('div');
            div.className = `message ${msg.fromMe ? 'me' : 'friend'}`;
            div.dataset.messageId = msg.id;
            
            let statusIcon = '‚àí';
            let statusTitle = '–ù–µ –ø—Ä–æ—á–∏—Ç–∞–Ω–æ';
            
            if (msg.fromMe) {
                if (msg.readAt) {
                    statusIcon = '+';
                    statusTitle = `–ü—Ä–æ—á–∏—Ç–∞–Ω–æ: ${formatDateTime(msg.readAt)}`;
                }
            }
            
            if (msg.fromMe) {
                div.innerHTML = `
                    <div class="message-content">
                        <div class="message-text">${msg.text || ""}</div>
                        <div class="message-time">
                            <span class="message-status" title="${statusTitle}">${statusIcon}</span>
                            ${formatTime(msg.timestamp)}
                        </div>
                    </div>
                `;
                
                const statusElement = div.querySelector('.message-status');
                if (statusElement) {
                    statusElement.addEventListener('click', (e) => {
                        e.stopPropagation();
                        showMessageDetails(msg);
                    });
                }
            } else {
                if (isPersonalChat) {
                    div.innerHTML = `
                        <div class="message-content">
                            <div class="message-text">${msg.text || ""}</div>
                            <div class="message-time">${formatTime(msg.timestamp)}</div>
                        </div>
                    `;
                } else {
                    div.innerHTML = `
                        <div class="message-content">
                            <div class="message-sender">${msg.senderName || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"}</div>
                            <div class="message-text">${msg.text || ""}</div>
                            <div class="message-time">${formatTime(msg.timestamp)}</div>
                        </div>
                    `;
                }
            }
            
            container.appendChild(div);
        });
        
        setTimeout(() => {
            container.scrollTop = container.scrollHeight;
        }, 100);
    }

    // ======================= –§–£–ù–ö–¶–ò–ò –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–Ø –í–†–ï–ú–ï–ù–ò =======================
    function formatTime(timestamp) {
        try {
            let timeStr = timestamp;
            if (timeStr && !timeStr.endsWith('Z') && timeStr.includes('T')) {
                timeStr += 'Z';
            }
            
            const date = new Date(timeStr);
            
            if (isNaN(date.getTime())) {
                throw new Error('Invalid date');
            }
            
            return date.toLocaleTimeString([], {
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            });
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –≤—Ä–µ–º–µ–Ω–∏:', timestamp, e);
            return '--:--';
        }
    }

    function formatChatTime(timestamp) {
        if (!timestamp) return '';
        
        try {
            let timeStr = timestamp;
            if (timeStr && !timeStr.endsWith('Z') && timeStr.includes('T')) {
                timeStr += 'Z';
            }
            
            const date = new Date(timeStr);
            const now = new Date();
            
            // –°–µ–≥–æ–¥–Ω—è - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Ä–µ–º—è (14:30)
            if (date.toDateString() === now.toDateString()) {
                return date.toLocaleTimeString([], {
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                });
            }
            
            // –í—á–µ—Ä–∞
            const yesterday = new Date(now);
            yesterday.setDate(yesterday.getDate() - 1);
            if (date.toDateString() === yesterday.toDateString()) {
                return '–≤—á–µ—Ä–∞';
            }
            
            // –ù–∞ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ
            const weekAgo = new Date(now);
            weekAgo.setDate(weekAgo.getDate() - 7);
            if (date > weekAgo) {
                const days = ['–≤—Å', '–ø–Ω', '–≤—Ç', '—Å—Ä', '—á—Ç', '–ø—Ç', '—Å–±'];
                return days[date.getDay()];
            }
            
            // –°—Ç–∞—Ä–µ–µ –Ω–µ–¥–µ–ª–∏ - –¥–∞—Ç–∞
            return date.toLocaleDateString([], {
                day: '2-digit',
                month: '2-digit'
            });
        } catch (e) {
            return '';
        }
    }

    function formatDateTime(dateString) {
        if (!dateString) return '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
        
        try {
            let timeStr = dateString;
            if (timeStr && !timeStr.endsWith('Z') && timeStr.includes('T')) {
                timeStr += 'Z';
            }
            
            const date = new Date(timeStr);
            
            if (isNaN(date.getTime())) {
                throw new Error('Invalid date');
            }
            
            return date.toLocaleString('ru-RU', {
                day: '2-digit',
                month: '2-digit', 
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –ø–æ–ª–Ω–æ–π –¥–∞—Ç—ã:', dateString, e);
            return '–æ—à–∏–±–∫–∞ –¥–∞—Ç—ã';
        }
    }

    // ======================= –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï –î–ê–¢–´ –î–õ–Ø –°–û–û–ë–©–ï–ù–ò–ô =======================
    function formatMessageDate(date) {
        const now = new Date();
        
        const months = [
            '—è–Ω–≤–∞—Ä—è', '—Ñ–µ–≤—Ä–∞–ª—è', '–º–∞—Ä—Ç–∞', '–∞–ø—Ä–µ–ª—è', '–º–∞—è', '–∏—é–Ω—è',
            '–∏—é–ª—è', '–∞–≤–≥—É—Å—Ç–∞', '—Å–µ–Ω—Ç—è–±—Ä—è', '–æ–∫—Ç—è–±—Ä—è', '–Ω–æ—è–±—Ä—è', '–¥–µ–∫–∞–±—Ä—è'
        ];
        
        const day = date.getDate();
        const month = months[date.getMonth()];
        
        // –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Ç–µ–∫—É—â–µ–º –≥–æ–¥—É - —Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ –∏ –º–µ—Å—è—Ü
        if (date.getFullYear() === now.getFullYear()) {
            return `${day} ${month}`;
        }
        
        // –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –¥—Ä—É–≥–æ–º –≥–æ–¥—É - –¥–æ–±–∞–≤–ª—è–µ–º –≥–æ–¥
        return `${day} ${month} ${date.getFullYear()}`;
    }
        
    // ============================ –£–î–ê–õ–ï–ù–ò–ï –ß–ê–¢–ê ==============================
    function deleteCurrentChat() {
        if (!currentChatId) {
            alert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è");
            return;
        }
        
        const chat = chatsData[currentChatId];
        if (!chat) {
            alert("–ß–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω");
            return;
        }
        
        if (!confirm(`–£–¥–∞–ª–∏—Ç—å —á–∞—Ç "${chat.name}"?\n\n–≠—Ç–æ —É–¥–∞–ª–∏—Ç —á–∞—Ç –¥–ª—è –≤–∞—Å –∏ –≤–∞—à–µ–≥–æ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞.\n–í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ.`)) {
            return;
        }
        
        const statusEl = document.getElementById('online-status');
        const originalText = statusEl.textContent;
        statusEl.textContent = '–£–¥–∞–ª—è–µ–º...';
        
        const deleteBtn = document.getElementById('deleteChatBtn');
        const originalBtnText = deleteBtn.textContent;
        deleteBtn.textContent = '–£–¥–∞–ª–µ–Ω–∏–µ...';
        deleteBtn.disabled = true;
        
        apiRequest(`/chat/${currentChatId}/delete_for_all`, {
            method: 'DELETE'
        })
        .then(response => {
            console.log('–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏:', response);
            
            if (response && response.deleted) {
                alert(`–ß–∞—Ç "${chat.name}" —É–¥–∞–ª—ë–Ω${response.deleted_for_all ? ' –¥–ª—è –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤' : ''}`);
                
                delete chatsData[currentChatId];
                
                currentChatId = null;
                currentPartnerId = null;
                localStorage.removeItem('LAST_OPENED_CHAT');
                
                if (statusCheckInterval) {
                    clearInterval(statusCheckInterval);
                    statusCheckInterval = null;
                }
                
                document.getElementById('current-chat-name').textContent = '–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç';
                document.getElementById('current-avatar').textContent = '?';
                document.getElementById('current-avatar').style.backgroundColor = '';
                document.getElementById('online-status').textContent = '---';
                document.getElementById('inputArea').style.display = 'none';
                
                const messagesContainer = document.getElementById('messages-container');
                messagesContainer.innerHTML = 
                    '<div class="welcome-message"><p>–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –∏–∑ —Å–ø–∏—Å–∫–∞ —Å–ª–µ–≤–∞</p></div>';
                
                renderChatList();
                
                if (Object.keys(chatsData).length === 0) {
                    showNoChatsMessage();
                }
                
            } else {
                alert("–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —á–∞—Ç");
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —á–∞—Ç–∞:', error);
            
            let errorMessage = '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —á–∞—Ç';
            
            if (error.message.includes('404')) {
                errorMessage = '–ß–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω';
            } else if (error.message.includes('403')) {
                errorMessage = '–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —ç—Ç–æ–≥–æ —á–∞—Ç–∞';
            } else if (error.message.includes('400')) {
                errorMessage = '–ú–æ–∂–Ω–æ —É–¥–∞–ª—è—Ç—å —Ç–æ–ª—å–∫–æ –ª–∏—á–Ω—ã–µ —á–∞—Ç—ã';
            }
            
            alert(errorMessage);
        })
        .finally(() => {
            statusEl.textContent = originalText;
            deleteBtn.textContent = originalBtnText;
            deleteBtn.disabled = true;
        });
    }
    
    function showMessageDetails(message) {
        let details = '';
        
        if (message.timestamp) {
            details += `<p><strong>–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ:</strong> ${formatDateTime(message.timestamp)}</p>`;
        }
        
        if (message.readAt) {
            details += `<p><strong>–ü—Ä–æ—á–∏—Ç–∞–Ω–æ:</strong> ${formatDateTime(message.readAt)}</p>`;
        } else {
            details += `<p><strong>–ü—Ä–æ—á–∏—Ç–∞–Ω–æ:</strong> –µ—â–µ –Ω–µ –ø—Ä–æ—á–∏—Ç–∞–Ω–æ</p>`;
        }
        
        const modal = document.createElement('div');
        modal.className = 'message-details-modal';
        modal.innerHTML = `
            <div class="modal-content">
                <div class="modal-header">
                    <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–æ–æ–±—â–µ–Ω–∏–∏</h3>
                    <button class="close-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="message-preview">
                        <p><strong>–¢–µ–∫—Å—Ç:</strong> ${message.text || "(–±–µ–∑ —Ç–µ–∫—Å—Ç–∞)"}</p>
                    </div>
                    <div class="message-details">
                        ${details}
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        modal.querySelector('.close-modal').addEventListener('click', () => {
            modal.remove();
        });
        
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.remove();
            }
        });
    }

    function sendMessage() {
        if (!currentChatId) {
            alert("–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è");
            return;
        }
        
        const input = document.getElementById('message-input');
        const text = input.value.trim();
        
        if (!text) return;
        
        const chat = chatsData[currentChatId];
        const now = new Date();
        const nowISO = now.toISOString();
        
        const newMsg = {
            id: Date.now(),
            text: text,
            time: formatTime(nowISO),
            fromMe: true,
            timestamp: nowISO,
            readAt: null,
            deliveredAt: null,
            senderName: currentUserName
        };
        
        chat.messages.push(newMsg);
        chat.last_message = text.length > 30 ? text.substring(0, 30) + "..." : text;
        chat.last_time = formatChatTime(nowISO);
        chat.last_message_raw = nowISO;
        
        renderMessages(currentChatId);
        renderChatList();
        input.value = '';
        
        apiRequest('/messages/by_user', {
            method: 'POST',
            body: JSON.stringify({ 
                id_query: String(chat.serverId),
                content: text
            })
        })
        .then(response => {
            if (response) {
                console.log("–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä:", response);
                
                if (response.id) {
                    newMsg.id = response.id;
                }
                if (response.timestamp) {
                    newMsg.timestamp = response.timestamp;
                    newMsg.time = formatTime(response.timestamp);
                    chat.last_time = formatChatTime(response.timestamp);
                    chat.last_message_raw = response.timestamp;
                    
                    renderChatList();
                }
            }
        })
        .catch(error => {
            console.error("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä:", error);
            alert("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å.");
        });
    }
    
    function logout() {
        if (confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?")) {
            updateMyStatus(false);
            
            if (statusCheckInterval) {
                clearInterval(statusCheckInterval);
            }
            
            localStorage.clear();
            window.location.href = "/";
        }
    }

    function setupEventListeners() {
        setupSearchListeners();
        document.getElementById('send-btn').addEventListener('click', sendMessage);
        
        document.getElementById('message-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                sendMessage();
            }
        });
        
        document.getElementById('logoutBtn').addEventListener('click', logout);
        document.getElementById('deleteChatBtn').addEventListener('click', deleteCurrentChat);
    }

    // ======================= –ó–ê–ü–£–°–ö =======================
    document.addEventListener('DOMContentLoaded', init);
    </script>
    
</body>
</html>